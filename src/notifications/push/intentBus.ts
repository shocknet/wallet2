import {
	PushNotificationEnvelope,
	PushNotificationEnvelopeValidate,
	PushNotificationPayload,
	PushNotificationPayloadValidate,
} from "@/Api/pub/autogenerated/ts/types";
import { nip44 } from "nostr-tools";
import { hexToBytes } from "@noble/hashes/utils";
import dLogger from "@/Api/helpers/debugLog";

const log = dLogger.withContext({ component: "push-intentBus" });

export type PushIntent = {
	topicId: string;
	payload: PushNotificationPayload;
	identityId: string;
	sourceId: string;
};

export function parseEnvelopeJsonString(value: string): PushNotificationEnvelope | null {
	try {
		const candidate = JSON.parse(value);
		const err = PushNotificationEnvelopeValidate(candidate);
		if (err) return null;
		return candidate as PushNotificationEnvelope;
	} catch {
		return null;
	}
}

export function parsePushEnvelopeFromPayload(payload: any): PushNotificationEnvelope | null {
	const err = PushNotificationEnvelopeValidate(payload);
	if (err) return null;
	return payload as PushNotificationEnvelope;
}

export function hasPushParams(url: URL): boolean {
	return url.searchParams.get("push") === "1";
}

export function parsePushEnvelopeFromUrl(url: URL): PushNotificationEnvelope | null {
	if (!hasPushParams(url)) return null;
	const rawEnvelope = url.searchParams.get("push_envelope");
	if (!rawEnvelope) return null;
	let decoded = rawEnvelope;
	try {
		decoded = decodeURIComponent(rawEnvelope);
	} catch {
		decoded = rawEnvelope;
	}
	return parseEnvelopeJsonString(decoded);
}

export function decryptPushEnvelope(
	envelope: PushNotificationEnvelope,
	privateKey: string,
): PushNotificationPayload | null {
	try {
		const sharedSecret = nip44.getConversationKey(hexToBytes(privateKey), envelope.app_npub_hex);
		const plaintext = nip44.decrypt(envelope.encrypted_payload, sharedSecret);
		const parsed = JSON.parse(plaintext);
		const err = PushNotificationPayloadValidate(parsed as PushNotificationPayload);
		if (err) return null;
		return parsed as PushNotificationPayload;
	} catch (err) {
		log.warn("decrypt_error", { error: err });
		return null;
	}
}

let pending: PushIntent | null = null;
let ready = false;
const listeners = new Set<(i: PushIntent) => void>();

const SS_KEY = "PUSH_CLICK_INTENT";
const ENVELOPE_SS_KEY = "PUSH_ENVELOPE";

export function setIntent(i: PushIntent) {
	pending = i;
	try { sessionStorage.setItem(SS_KEY, JSON.stringify(i)); } catch {/*  */ }
	try { sessionStorage.removeItem(ENVELOPE_SS_KEY); } catch {/*  */ }
	if (ready) listeners.forEach(fn => fn(i));
}

export function getIntent(): PushIntent | null {
	if (pending) return pending;
	try {
		const s = sessionStorage.getItem(SS_KEY);
		if (!s) return null;
		pending = JSON.parse(s);
		return pending;
	} catch {
		return null;
	}
}

export function clearIntent() {
	pending = null;
	try { sessionStorage.removeItem(SS_KEY); } catch {/*  */ }
}

export function setPendingEnvelope(envelope: PushNotificationEnvelope) {
	try { sessionStorage.setItem(ENVELOPE_SS_KEY, JSON.stringify(envelope)); } catch {/*  */ }
}

export function getPendingEnvelope(): PushNotificationEnvelope | null {
	try {
		const s = sessionStorage.getItem(ENVELOPE_SS_KEY);
		if (!s) return null;
		const parsed = JSON.parse(s);
		const err = PushNotificationEnvelopeValidate(parsed as PushNotificationEnvelope);
		if (err) return null;
		return parsed as PushNotificationEnvelope;
	} catch {
		return null;
	}
}

export function clearPendingEnvelope() {
	try { sessionStorage.removeItem(ENVELOPE_SS_KEY); } catch {/*  */ }
}

export function markReady() {
	ready = true;
	const i = getIntent();
	if (i) listeners.forEach(fn => fn(i));
}

export function onIntent(fn: (i: PushIntent) => void) {
	listeners.add(fn);
	return () => {
		listeners.delete(fn)
	}
}
