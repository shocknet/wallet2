import { useEffect } from "react";
import { useIonRouter } from "@ionic/react";
import { onIntent, clearIntent, markReady, PushIntent } from "@/notifications/push/intentBus";
import { setPendingNav } from "@/notifications/push/pendingNav";
import { useAppDispatch, useAppSelector } from "@/State/store/hooks";
import { selectActiveIdentityId } from "@/State/identitiesRegistry/slice";
import { switchIdentity } from "@/State/identitiesRegistry/thunks";
import { PushNotificationPayload_data_type } from "@/Api/pub/autogenerated/ts/types";
import { useHistory } from "react-router-dom";
import dLogger from "@/Api/helpers/debugLog";

const log = dLogger.withContext({ component: "push-controller" });

type RouteIntent = {
	path: string;
	state?: any;
};

function routeForPayload(pushIntent: PushIntent): RouteIntent {
	if (pushIntent.payload.data.type === PushNotificationPayload_data_type.RECEIVED_OPERATION) {
		const opId = pushIntent.payload.data.received_operation.operationId;
		if (opId) return { path: "/home", state: { notif_op_id: opId, sourceId: pushIntent.sourceId } };
	}
	if (pushIntent.payload.data.type === PushNotificationPayload_data_type.SENT_OPERATION) {
		const opId = pushIntent.payload.data.sent_operation.operationId;
		if (opId) return { path: "/home", state: { notif_op_id: opId, sourceId: pushIntent.sourceId } };
	}
	return { path: "/home" };
}

export function PushIntentController() {
	const history = useHistory();
	const dispatch = useAppDispatch();
	const activeIdentityId = useAppSelector(selectActiveIdentityId);

	useEffect(() => {
		const unsubscribe = onIntent(async (intent) => {
			log.info("intent_handled", { data: { identityId: intent.identityId, path: routeForPayload(intent).path } });
			const targetRoute = routeForPayload(intent);


			if (intent.identityId !== activeIdentityId) {
				setPendingNav({
					path: targetRoute.path,
					state: targetRoute.state,
					identityId: intent.identityId
				});
				clearIntent();
				await dispatch(switchIdentity(intent.identityId));
				return;
			}

			history.replace(targetRoute.path, targetRoute.state);
			clearIntent();
		});
		markReady();
		return unsubscribe;
	}, [dispatch, history, activeIdentityId]);

	return null;
}
