import { Capacitor } from "@capacitor/core";
import {
	setIntent,
	parsePushEnvelopeFromPayload,
	parseEnvelopeJsonString,
	parsePushEnvelopeFromUrl,
	hasPushParams,
	decryptPushEnvelope,
	setPendingEnvelope,
	clearPendingEnvelope
} from "./intentBus";
import { PushNotifications } from "@capacitor/push-notifications";
import { resolveTopicTarget } from "./topicResolver";
import { PushNotificationEnvelope } from "@/Api/pub/autogenerated/ts/types";
import dLogger from "@/Api/helpers/debugLog";

const log = dLogger.withContext({ component: "push-capture" });

/**
 * Common logic to process a parsed envelope: resolve topic, decrypt, and set intent
 */
async function processEnvelope(envelope: PushNotificationEnvelope, source: string) {
	log.debug("envelope_received", { data: { source } });
	setPendingEnvelope(envelope);

	const resolution = await resolveTopicTarget(envelope.topic_id);
	if (!resolution) {
		log.warn("topic_resolve_failed", { data: { source } });
		return;
	}

	const payload = decryptPushEnvelope(envelope, resolution.privateKey);
	if (!payload) {
		log.warn("decrypt_failed", { data: { source } });
		return;
	}

	setIntent({
		topicId: envelope.topic_id,
		payload,
		identityId: resolution.identityId,
		sourceId: resolution.sourceId
	});
	log.info("intent_set", { data: { source, identityId: resolution.identityId } });
	clearPendingEnvelope();
}

export function captureWebEarly() {
	const u = new URL(window.location.href);
	if (hasPushParams(u)) {
		const envelope = parsePushEnvelopeFromUrl(u);
		u.searchParams.delete("push");
		u.searchParams.delete("push_envelope");
		history.replaceState({}, "", u.toString());
		if (envelope) {
			void processEnvelope(envelope, "web-cold-start");
		}
	}

	if ("serviceWorker" in navigator) {
		navigator.serviceWorker.addEventListener("message", (ev) => {
			const parsedEnvelope = parsePushEnvelopeFromPayload(ev.data);
			if (parsedEnvelope) {
				void processEnvelope(parsedEnvelope, "web-warm-start");
			}
		});
	}
}

export function captureNativeEarly() {
	const platform = Capacitor.getPlatform();
	if (platform === "web") return;

	PushNotifications.addListener("pushNotificationActionPerformed", (action) => {
		const d: any = action.notification?.data;
		const rawEnvelope = typeof d?.raw === "string"
			? d.raw
			: typeof d === "string"
				? d
				: null;

		if (!rawEnvelope) {
			log.warn("native_no_raw_envelope", { data: { hasData: !!d } });
			return;
		}

		const parsedEnvelope = parseEnvelopeJsonString(rawEnvelope);
		if (parsedEnvelope) {
			void processEnvelope(parsedEnvelope, `native-${platform}`);
		}
	});
}
