import { Capacitor } from "@capacitor/core";
import {
	setIntent,
	parsePushEnvelopeFromPayload,
	parseEnvelopeJsonString,
	parsePushEnvelopeFromUrl,
	hasPushParams,
	decryptPushEnvelope,
	setPendingEnvelope,
	clearPendingEnvelope
} from "./intentBus";
import { PushNotifications } from "@capacitor/push-notifications";
import { resolveTopicTarget } from "./topicResolver";
import { PushNotificationEnvelope } from "@/Api/pub/autogenerated/ts/types";


/**
 * Common logic to process a parsed envelope: resolve topic, decrypt, and set intent
 */
async function processEnvelope(envelope: PushNotificationEnvelope, source: string) {
	console.log(`[Push] Processing envelope from ${source}:`, envelope);
	setPendingEnvelope(envelope);

	const resolution = await resolveTopicTarget(envelope.topic_id);
	if (!resolution) {
		console.warn(`[Push] Failed to resolve topic for ${source}`);
		return;
	}

	const payload = decryptPushEnvelope(envelope, resolution.privateKey);
	if (!payload) {
		console.warn(`[Push] Failed to decrypt payload for ${source}`);
		return;
	}

	const intent = {
		topicId: envelope.topic_id,
		payload,
		identityId: resolution.identityId,
		sourceId: resolution.sourceId
	};

	console.log(`[Push] Resolved intent from ${source}:`, intent);
	setIntent(intent);
	clearPendingEnvelope();
}

export function captureWebEarly() {
	// Cold start: check URL params
	const u = new URL(window.location.href);
	if (hasPushParams(u)) {
		console.log("[Push] Cold start with push params");
		const envelope = parsePushEnvelopeFromUrl(u);

		// Scrub URL params
		u.searchParams.delete("push");
		u.searchParams.delete("push_envelope");
		history.replaceState({}, "", u.toString());

		if (envelope) {
			void processEnvelope(envelope, "web-cold-start");
		}
	}

	// Warm start: listen for service worker postMessage
	if ("serviceWorker" in navigator) {
		navigator.serviceWorker.addEventListener("message", (event) => {
			const parsedEnvelope = parsePushEnvelopeFromPayload(event.data);
			if (parsedEnvelope) {
				void processEnvelope(parsedEnvelope, "web-warm-start");
			}
		});
	}
}

export function captureNativeEarly() {
	const platform = Capacitor.getPlatform();
	if (platform === "web") return;

	PushNotifications.addListener("pushNotificationActionPerformed", (action) => {
		console.log("[Push] Native notification tapped:", action);
		alert(JSON.stringify(action));


		const d: any = action.notification?.data;


		const rawEnvelope = typeof d?.raw === "string"
			? d.raw
			: typeof d === "string"
				? d
				: null;

		if (!rawEnvelope) {
			console.warn("[Push] No raw envelope found in native notification data:", d);
			return;
		}

		const parsedEnvelope = parseEnvelopeJsonString(rawEnvelope);
		if (parsedEnvelope) {
			void processEnvelope(parsedEnvelope, `native-${platform}`);
		}
	});
}
