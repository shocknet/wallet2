import { IonButton, IonContent, IonFooter, IonHeader, IonIcon, IonInput, IonPage, IonRow, IonText, IonCard, IonCardContent, IonCardHeader, IonCardTitle, IonBadge } from "@ionic/react";
import BackToolbar from "@/Layout2/BackToolbar";
import AmountInput from "@/Components/AmountInput";
import { useEffect, useState } from "react";
import SpendFromDropdown from "@/Components/Dropdowns/SpendFromDropdown";
import { getNostrClient } from "@/Api/nostr";
import { TransactionSwapQuote, TxSwapsList, TxSwapOperation } from "@/Api/pub/autogenerated/ts/types";
import { toast } from "react-toastify";
import { selectNprofileViews } from "@/State/scoped/backups/sources/selectors";
import { useAppSelector } from "@/State/store/hooks";
import { flashOutline, checkmarkCircle, closeCircle, walletOutline } from "ionicons/icons";
import { useIonLoading } from "@ionic/react";

export default function Swaps() {
    const [amount, setAmount] = useState<string>("");
    const [quotes, setQuotes] = useState<TransactionSwapQuote[]>([]);
    const [address, setAddress] = useState<string>("");
    const nprofileViews = useAppSelector(selectNprofileViews);
    const [selectedView, setSelectedView] = useState(nprofileViews[0]);
    const [swaps, setSwaps] = useState<TxSwapsList>({ swaps: [] });
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [presentLoading, dismissLoading] = useIonLoading();

    const fetchSwaps = async () => {
        if (!selectedView) return;
        setError(null);
        setLoading(true);
        try {
            await dismissLoading();
            await presentLoading("Fetching swaps...");
            const client = await getNostrClient({ pubkey: selectedView.lpk, relays: selectedView.relays }, selectedView.keys);
            const result = await client.ListTxSwaps();
            await dismissLoading();
            if (result.status !== "OK") {
                console.error("Failed to load swaps", result);
                setError(result.reason ?? "Failed to load swaps");
                toast.error(result.reason);
                return;
            }
            setSwaps({ swaps: result.swaps });
        } catch (e) {
            await dismissLoading();
            const msg = e instanceof Error ? e.message : "Failed to load swaps";
            setError(msg);
            toast.error(msg);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchSwaps();
    }, [selectedView?.sourceId ?? selectedView?.lpk]);

    const requestQuote = async () => {
        if (!selectedView) return;
        setError(null);
        try {
            await dismissLoading();
            await presentLoading("Fetching quote...");
            const client = await getNostrClient({ pubkey: selectedView.lpk, relays: selectedView.relays }, selectedView.keys);
            const quote = await client.GetTransactionSwapQuotes({ transaction_amount_sats: +amount });
            await dismissLoading();
            if (quote.status !== "OK") {
                console.error("Failed to get quotes", quote);
                setError(quote.reason ?? "Failed to get quotes");
                toast.error(quote.reason);
                return;
            }
            setQuotes(quote.quotes ?? []);
        } catch (e) {
            await dismissLoading();
            const msg = e instanceof Error ? e.message : "Failed to get quotes";
            setError(msg);
            toast.error(msg);
        }
    };

    const doSwap = async (swapOpId: string) => {
        if (!selectedView) return;
        if (!address?.trim()) {
            toast.error("Enter a destination address");
            return;
        }
        setError(null);
        try {
            await dismissLoading();
            await presentLoading("Doing swap...");
            const client = await getNostrClient({ pubkey: selectedView.lpk, relays: selectedView.relays }, selectedView.keys);
            const res = await client.PayAddress({
                address: address.trim(),
                amountSats: 0,
                satsPerVByte: 0,
                swap_operation_id: swapOpId,
            });
            await dismissLoading();
            if (res.status !== "OK") {
                console.error("Failed to pay swap", res);
                setError(res.reason ?? "Swap failed");
                toast.error(res.reason);
                void fetchSwaps();
                return;
            }
            toast.success("Swap successful");
            setAddress("");
            void fetchSwaps();
        } catch (e) {
            await dismissLoading();
            const msg = e instanceof Error ? e.message : "Swap failed";
            setError(msg);
            toast.error(msg);
            void fetchSwaps();
        }
    };

    const cancelSwap = () => {
        setQuotes([]);
        void fetchSwaps();
    };

    const oldQuotes = "quotes" in swaps && Array.isArray(swaps.quotes) ? swaps.quotes : [];
    const completedSwaps = swaps.swaps ?? [];

    return (
        <IonPage className="ion-page-width">
            <IonHeader className="ion-no-border">
                <BackToolbar title="Swaps" />
            </IonHeader>
            <IonContent className="ion-padding ion-content-no-footer">
                <IonRow>
                    <SpendFromDropdown values={nprofileViews} value={selectedView} callback={setSelectedView} />
                </IonRow>

                {error && (
                    <div style={{
                        padding: 12,
                        marginBottom: 12,
                        background: 'var(--ion-color-danger-tint)',
                        borderRadius: '8px',
                        color: 'var(--ion-color-danger-shade)',
                        border: '1px solid var(--ion-color-danger)',
                    }}>
                        <div style={{ fontWeight: 700, marginBottom: 8 }}>Something went wrong</div>
                        <div style={{ marginBottom: 12 }}>{error}</div>
                        <IonButton onClick={() => void fetchSwaps()}>Retry</IonButton>
                    </div>
                )}

                {quotes.length === 0 && (
                    <IonCard>
                        <IonCardHeader>
                            <IonCardTitle>Request New Transaction Swap Quote</IonCardTitle>
                        </IonCardHeader>
                        <IonCardContent>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                <IonText color="medium">
                                    Amount received by destination address (in sats)
                                </IonText>
                                <AmountInput
                                    displayValue={amount}
                                    effectiveSats={null}
                                    onType={(text) => { setAmount(text); return text; }}
                                    unit="sats"
                                    onToggleUnit={() => { }}
                                />
                                <IonButton
                                    expand="block"
                                    onClick={() => void requestQuote()}
                                    disabled={!amount || Number(amount) <= 0}
                                >
                                    <IonIcon icon={flashOutline} slot="start" />
                                    Get Quotes from Services
                                </IonButton>
                            </div>
                        </IonCardContent>
                    </IonCard>
                )}

                {quotes.length > 0 && (
                    <>
                        <IonText className="ion-margin-top" style={{ fontSize: "1.4rem", fontWeight: "bold", display: "block", marginBottom: "12px" }}>
                            <IonIcon icon={flashOutline} style={{ marginRight: "8px" }} />
                            New Quotes Available
                        </IonText>
                        {quotes.map(quote => (
                            <IonCard key={quote.swap_operation_id} style={{ border: '2px solid var(--ion-color-primary)' }}>
                                <IonCardHeader>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <IonCardTitle style={{ fontSize: '1rem' }}>
                                            {quote.service_url}
                                        </IonCardTitle>
                                        <IonBadge color="primary">New Quote</IonBadge>
                                    </div>
                                </IonCardHeader>
                                <IonCardContent>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        <div style={{
                                            padding: '12px',
                                            background: 'var(--ion-color-primary-tint)',
                                            borderRadius: '8px',
                                            marginBottom: '8px'
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <IonText><strong>Sent to address:</strong></IonText>
                                                <IonText><strong>{quote.transaction_amount_sats.toLocaleString()} sats</strong></IonText>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <IonText color="warning"><strong>Swap + chain fee:</strong></IonText>
                                                <IonText color="warning"><strong>{(quote.swap_fee_sats + quote.chain_fee_sats).toLocaleString()} sats</strong></IonText>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <IonText><strong>Service fee:</strong></IonText>
                                                <IonText><strong>{quote.service_fee_sats.toLocaleString()} sats</strong></IonText>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                <IonText><strong>Total spent:</strong></IonText>
                                                <IonText><strong>{(quote.service_fee_sats + quote.invoice_amount_sats).toLocaleString()} sats</strong></IonText>
                                            </div>
                                        </div>
                                        <div style={{ fontSize: '0.85rem' }}>
                                            <div style={{ marginBottom: '4px' }}>
                                                <IonText color="medium">Destination address to send to:</IonText>
                                            </div>
                                            <IonInput
                                                label="Address"
                                                value={address}
                                                onIonChange={(e) => setAddress(e.detail.value || "")}
                                                placeholder="Enter on-chain address"
                                                style={{
                                                    marginTop: '4px',
                                                    background: 'var(--ion-color-light)',
                                                    borderRadius: '4px',
                                                    fontFamily: 'monospace',
                                                    fontSize: '0.85rem'
                                                }}
                                            />
                                        </div>
                                        <IonButton
                                            expand="block"
                                            onClick={() => void doSwap(quote.swap_operation_id)}
                                            disabled={!address?.trim()}
                                        >
                                            <IonIcon icon={flashOutline} slot="start" />
                                            Execute Swap
                                        </IonButton>
                                    </div>
                                </IonCardContent>
                            </IonCard>
                        ))}
                        <IonButton
                            expand="block"
                            fill="outline"
                            onClick={cancelSwap}
                            style={{ marginTop: '8px', marginBottom: '16px' }}
                        >
                            Cancel & Request New Amount
                        </IonButton>
                    </>
                )}

                {/* Swap operations list */}
                <IonCard>
                    <IonCardHeader>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <IonCardTitle>Swap Operations</IonCardTitle>
                            <IonButton size="small" fill="outline" onClick={() => void fetchSwaps()}>
                                Refresh
                            </IonButton>
                        </div>
                    </IonCardHeader>
                    <IonCardContent>
                        {(oldQuotes.length > 0 || completedSwaps.length > 0) && (
                            <IonText color="medium" style={{ fontSize: '0.9rem' }}>
                                {oldQuotes.length > 0 && <>Pending quotes: {oldQuotes.length}</>}
                                {oldQuotes.length > 0 && completedSwaps.length > 0 && " · "}
                                {completedSwaps.length > 0 && <>Completed: {completedSwaps.length}</>}
                            </IonText>
                        )}
                    </IonCardContent>
                </IonCard>

                {oldQuotes.length === 0 && completedSwaps.length === 0 && quotes.length === 0 && (
                    <IonCard>
                        <IonCardContent style={{ textAlign: 'center', padding: '32px' }}>
                            <IonIcon
                                icon={walletOutline}
                                style={{ fontSize: '64px', color: 'var(--ion-color-medium)', marginBottom: '16px' }}
                            />
                            <IonText color="medium">
                                <h3>No swap operations yet</h3>
                                <p>Request a quote above to get started with transaction swaps</p>
                            </IonText>
                        </IonCardContent>
                    </IonCard>
                )}

                {oldQuotes.length > 0 && (
                    <>
                        <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                            Pending Quotes
                        </IonText>
                        {oldQuotes.map(quote => (
                            <IonCard key={quote.swap_operation_id}>
                                <IonCardHeader>
                                    <IonCardTitle style={{ fontSize: '1rem' }}>{quote.service_url}</IonCardTitle>
                                </IonCardHeader>
                                <IonCardContent>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                            <IonText color="medium">Sent to address:</IonText>
                                            <IonText><strong>{quote.transaction_amount_sats.toLocaleString()} sats</strong></IonText>
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                            <IonText color="medium">Swap + chain fee:</IonText>
                                            <IonText><strong>{(quote.swap_fee_sats + quote.chain_fee_sats).toLocaleString()} sats</strong></IonText>
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                            <IonText color="medium">Total spent:</IonText>
                                            <IonText><strong>{(quote.service_fee_sats + quote.invoice_amount_sats).toLocaleString()} sats</strong></IonText>
                                        </div>
                                        <IonInput
                                            label="Address"
                                            value={address}
                                            onIonChange={(e) => setAddress(e.detail.value || "")}
                                            placeholder="Enter on-chain address"
                                            style={{ marginTop: '8px' }}
                                        />
                                        <IonButton size="small" onClick={() => void doSwap(quote.swap_operation_id)} disabled={!address?.trim()}>
                                            Execute Swap
                                        </IonButton>
                                    </div>
                                </IonCardContent>
                            </IonCard>
                        ))}
                    </>
                )}

                {completedSwaps.length > 0 && (
                    <>
                        <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                            Completed Swaps
                        </IonText>
                        {completedSwaps.map((op: TxSwapOperation) => (
                            <IonCard key={op.quote.swap_operation_id}>
                                <IonCardContent>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                                        {!op.failure_reason ? (
                                            <>
                                                <IonIcon icon={checkmarkCircle} color="success" style={{ fontSize: '24px' }} />
                                                <IonText>Success: {op.operation_payment?.amount?.toLocaleString()} sats to {op.address_paid ?? '—'}</IonText>
                                            </>
                                        ) : (
                                            <>
                                                <IonIcon icon={closeCircle} color="danger" style={{ fontSize: '24px' }} />
                                                <IonText color="danger">Failed: {op.operation_payment?.amount?.toLocaleString()} sats to {op.address_paid ?? '—'} — {op.failure_reason}</IonText>
                                            </>
                                        )}
                                    </div>
                                </IonCardContent>
                            </IonCard>
                        ))}
                    </>
                )}
            </IonContent>
            <IonFooter className="ion-no-border" />
        </IonPage>
    );
}
