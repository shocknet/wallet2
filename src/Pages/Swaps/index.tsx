import { IonButton, IonFooter, IonHeader, IonInput, IonItem, IonPage, IonRow, IonText } from "@ionic/react";
import BackToolbar from "@/Layout2/BackToolbar";
import AmountInput from "@/Components/AmountInput";
import { useEffect, useState } from "react";
import SpendFromDropdown from "@/Components/Dropdowns/SpendFromDropdown";
import { getNostrClient } from "@/Api/nostr";
import { TransactionSwapQuote, SwapsList } from "@/Api/pub/autogenerated/ts/types";
import { toast } from "react-toastify";
import { selectNprofileViews } from "@/State/scoped/backups/sources/selectors";
import { useAppSelector } from "@/State/store/hooks";
export default function Swaps() {
    const [amount, setAmount] = useState<string>("");
    const [quotes, setQuotes] = useState<TransactionSwapQuote[]>([]);
    const [address, setAddress] = useState<string>("");
    const nprofileViews = useAppSelector(selectNprofileViews);
    const [selectedView, setSelectedView] = useState(nprofileViews[0]);
    const [swaps, setSwaps] = useState<SwapsList>({ quotes: [], swaps: [] });
    const fetchSwaps = async () => {
        const client = await getNostrClient({ pubkey: selectedView.lpk, relays: selectedView.relays }, selectedView.keys)
        const swaps = await client.ListSwaps()
        if (swaps.status !== "OK") {
            toast.error(swaps.reason);
            return;
        }
        setSwaps(swaps);
    }
    useEffect(() => {
        fetchSwaps();
    }, [selectedView])
    const requestQuote = async () => {
        const client = await getNostrClient({ pubkey: selectedView.lpk, relays: selectedView.relays }, selectedView.keys)
        const quote = await client.GetTransactionSwapQuotes({ transaction_amount_sats: +amount })
        if (quote.status !== "OK") {
            toast.error(quote.reason);
            return;
        }
        setQuotes(quote.quotes);
    }
    const doSwap = async (swapOpId: string) => {
        const client = await getNostrClient({ pubkey: selectedView.lpk, relays: selectedView.relays }, selectedView.keys)
        const res = await client.PayAddress({
            address: address,
            amountSats: 0,
            satsPerVByte: 0,
            swap_operation_id: swapOpId,
        })
        if (res.status !== "OK") {
            fetchSwaps();
            toast.error(res.reason);
            return;
        }
        fetchSwaps();
        toast.success("Swap successful");
    }
    const cancelSwap = () => {
        setQuotes([]);
        fetchSwaps();
    }
    return (
        <IonPage className="ion-page-width">
            <IonHeader className="ion-no-border">
                <BackToolbar title="Swaps" />
            </IonHeader>
            {/* <IonContent className="ion-padding" > */}
            <IonRow>
                <SpendFromDropdown values={nprofileViews} value={selectedView} callback={setSelectedView} />
            </IonRow>

            {quotes.length === 0 && <>
                <IonRow className="ion-margin-top"> <IonText>Amount received by destination address</IonText></IonRow>
                <AmountInput
                    displayValue={amount}
                    effectiveSats={null}
                    onType={(text) => { setAmount(text); return text; }}
                    unit="sats"
                    onToggleUnit={() => { }}
                />
                <IonButton onClick={requestQuote}>
                    Request Quote
                </IonButton>
            </>}
            {quotes.length > 0 && <IonRow><IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold" }}>New Quotes</IonText></IonRow>}
            {quotes.length > 0 && quotes.map(quote => <div key={quote.swap_operation_id}>
                <IonRow> <IonText style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Quote from {quote.service_url}</IonText></IonRow>
                <IonRow className="ion-margin-top"> <IonText>{quote.transaction_amount_sats} sats will be sent to address</IonText></IonRow>
                <IonRow  > <IonText>{quote.swap_fee_sats + quote.chain_fee_sats} sats will be paid for the swap</IonText></IonRow>
                <IonRow  > <IonText>{quote.service_fee_sats} sats will be paid for the service</IonText></IonRow>
                <IonRow className="ion-margin-top"> <IonText>{quote.service_fee_sats + quote.invoice_amount_sats} sats will be the total spent for the swap </IonText></IonRow>

                <IonRow className="ion-margin-top"> <IonText>Address to send to</IonText></IonRow>
                <IonInput
                    label="Address"
                    value={address}
                    onIonChange={(e) => setAddress(e.detail.value || "")}
                />
                <IonButton onClick={() => doSwap(quote.swap_operation_id)}>Swap</IonButton>
            </div>)}
            {quotes.length > 0 && <IonButton onClick={cancelSwap}>Change Swap Amount</IonButton>}

            {swaps.quotes.length > 0 && <IonRow><IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Old Quotes</IonText></IonRow>}
            {swaps.quotes.map(quote => <div key={quote.swap_operation_id}>
                <IonRow> <IonText style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Quote from {quote.service_url}</IonText></IonRow>
                <IonRow className="ion-margin-top"> <IonText>{quote.transaction_amount_sats} sats will be sent to address</IonText></IonRow>
                <IonRow  > <IonText>{quote.swap_fee_sats + quote.chain_fee_sats} sats will be paid for the swap</IonText></IonRow>
                <IonRow  > <IonText>{quote.service_fee_sats} sats will be paid for the service</IonText></IonRow>
                <IonRow className="ion-margin-top"> <IonText>{quote.service_fee_sats + quote.invoice_amount_sats} sats will be the total spent for the swap </IonText></IonRow>

                <IonRow className="ion-margin-top"> <IonText>Address to send to</IonText></IonRow>
                <IonInput
                    label="Address"
                    value={address}
                    onIonChange={(e) => setAddress(e.detail.value || "")}
                />
                <IonButton onClick={() => doSwap(quote.swap_operation_id)}>Swap</IonButton>
            </div>)}
            {swaps.swaps.length > 0 && <IonRow><IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Swaps</IonText></IonRow>}
            {swaps.swaps.map(op => <div key={op.swap_operation_id}>
                <IonItem>
                    {!op.failure_reason && <IonText>success: {op.operation_payment?.amount} sats to {op.address_paid}</IonText>}
                    {op.failure_reason && <IonText>failed: {op.operation_payment?.amount} sats to {op.address_paid} reason: {op.failure_reason}</IonText>}
                </IonItem>
            </div>)}
            <IonFooter className="ion-no-border">
            </IonFooter>
        </IonPage >
    )
}