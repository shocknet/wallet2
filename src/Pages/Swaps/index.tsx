import { IonButton, IonCol, IonContent, IonFooter, IonGrid, IonHeader, IonInput, IonItem, IonPage, IonRow, IonText } from "@ionic/react";
import BackToolbar from "@/Layout2/BackToolbar";
import AmountInput from "@/Components/AmountInput";
import { useEffect, useState } from "react";
import SpendFromDropdown from "@/Components/Dropdowns/SpendFromDropdown";
import { selectNostrSpends, useSelector } from "@/State/store";
import { getNostrClient } from "@/Api/nostr";
import { SwapOperation, TransactionSwapQuote, UserOperationType } from "@/Api/pub/autogenerated/ts/types";
import { toast } from "react-toastify";
import { Virtuoso } from "react-virtuoso";
export default function Swaps() {
    const [amount, setAmount] = useState<string>("");
    const [quote, setQuote] = useState<TransactionSwapQuote | null>(null);
    const [address, setAddress] = useState<string>("");
    const nostrSpends = useSelector(selectNostrSpends);
    const [selectedSource, setSelectedSource] = useState(nostrSpends[0]);
    const [swaps, setSwaps] = useState<SwapOperation[]>([]);
    const fetchSwaps = async () => {
        const client = await getNostrClient(selectedSource.pasteField, selectedSource.keys)
        const swaps = await client.ListSwaps()
        if (swaps.status !== "OK") {
            toast.error(swaps.reason);
            return;
        }
        setSwaps(swaps.swaps);
    }
    useEffect(() => {
        fetchSwaps();
    }, [selectedSource])
    const requestQuote = async () => {
        const client = await getNostrClient(selectedSource.pasteField, selectedSource.keys)
        const quote = await client.GetTransactionSwapQuote({ transaction_amount_sats: +amount })
        if (quote.status !== "OK") {
            toast.error(quote.reason);
            return;
        }
        setQuote(quote);
    }
    const doSwap = async () => {
        if (!quote) {
            toast.error("No quote found");
            return;
        }
        const client = await getNostrClient(selectedSource.pasteField, selectedSource.keys)
        const res = await client.PayAddress({
            address: address,
            amoutSats: 0,
            satsPerVByte: 0,
            swap_operation_id: quote.swap_operation_id,
        })
        if (res.status !== "OK") {
            fetchSwaps();
            toast.error(res.reason);
            return;
        }
        fetchSwaps();
        toast.success("Swap successful");
    }
    const cancelSwap = () => {
        setQuote(null);
    }
    return (
        <IonPage className="ion-page-width">
            <IonHeader className="ion-no-border">
                <IonHeader className="ion-no-border">
                    <BackToolbar title="Swaps" />
                </IonHeader>
            </IonHeader>
            {/* <IonContent className="ion-padding" > */}
            <IonRow>
                <SpendFromDropdown values={nostrSpends} value={selectedSource} callback={setSelectedSource} />
            </IonRow>

            {!quote && <>
                <IonRow className="ion-margin-top"> <IonText>Amount received by destination address</IonText></IonRow>
                <AmountInput
                    displayValue={amount}
                    effectiveSats={null}
                    onToggleUnit={() => console.log("toggle unit")}
                    onType={(text) => { setAmount(text); return text; }}
                    unit="sats"

                />
                <IonButton onClick={requestQuote}>
                    Request Quote
                </IonButton>
            </>}
            {quote && <>
                <IonRow> <IonText style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Quote</IonText></IonRow>
                <IonRow className="ion-margin-top"> <IonText>{quote.transaction_amount_sats} sats will be sent to address</IonText></IonRow>
                <IonRow  > <IonText>{quote.swap_fee_sats + quote.chain_fee_sats} sats will be paid for the swap</IonText></IonRow>
                <IonRow  > <IonText>{quote.service_fee_sats} sats will be paid for the service</IonText></IonRow>
                <IonRow className="ion-margin-top"> <IonText>{quote.service_fee_sats + quote.invoice_amount_sats} sats will be the total spent for the swap </IonText></IonRow>

                <IonRow className="ion-margin-top"> <IonText>Addres to send to</IonText></IonRow>
                <IonInput
                    label="Address"
                    value={address}
                    onIonChange={(e) => setAddress(e.detail.value || "")}
                />
                <IonButton onClick={doSwap}>Swap</IonButton>
                <IonButton onClick={cancelSwap}>Cancel</IonButton>
            </>}
            <div >

            </div>
            {/* {swaps.map(s => <>
                    <IonRow> <IonText>{s.address_paid}</IonText></IonRow>
                </>)} */}
            {/* </IonContent > */}
            <IonRow><IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Swaps</IonText></IonRow>
            <IonContent scrollY={false}>
                <Virtuoso

                    data={swaps}
                    defaultItemHeight={56}
                    itemContent={(_, op) => (
                        <div
                            key={op.swap_operation_id}
                            style={{
                                minHeight: 56,
                                padding: "0 1rem"
                            }}
                        >
                            <IonItem>
                                {!op.failure_reason && <IonText>success: {op.operation_payment?.amount} sats to {op.address_paid}</IonText>}
                                {op.failure_reason && <IonText>failed: {op.operation_payment?.amount} sats to {op.address_paid} reason: {op.failure_reason}</IonText>}
                            </IonItem>
                        </div>
                    )}
                />
            </IonContent>
            <IonFooter className="ion-no-border">
            </IonFooter>
        </IonPage >
    )
}