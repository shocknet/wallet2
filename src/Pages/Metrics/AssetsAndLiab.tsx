import { useEffect, useMemo, useState } from "react";
import { fetcher, FetcherFuncs } from "./fetcher";
import { useAppSelector } from "@/State/store/hooks";
import { selectAdminNprofileViews } from "@/State/scoped/backups/sources/selectors";
import { selectSelectedMetricsAdminSourceId } from "@/State/runtime/slice";
import { useIonLoading, useIonRouter } from "@ionic/react";
import { IonButton, IonCard, IonCardContent, IonCardHeader, IonCardTitle, IonContent, IonHeader, IonIcon, IonItem, IonLabel, IonList, IonListHeader, IonPage, IonText } from "@ionic/react";
import {
    walletOutline,
    flashOutline,
    linkOutline,
    peopleOutline,
    receiptOutline,
    sendOutline,
    arrowDownOutline,
    arrowUpOutline,
    checkmarkCircleOutline,
    alertCircleOutline,
} from "ionicons/icons";
import { toast } from "react-toastify";
import {
    AssetsAndLiabilities,
    AssetsAndLiabilitiesReq,
    AssetOperation,
    LndAssetProvider,
    LiquidityAssetProvider,
    TrackedOperationType,
} from "@/Api/pub/autogenerated/ts/types";
import MetricsSubPageToolbar from "@/Layout2/Metrics/MetricsSubPageToolbar";

const now = Math.floor(Date.now() / 1000);
const anHour = 3600;
const aDay = 86400;

/** Test data to preview the full UI; replaced when real fetch completes. */
/* const MOCK_ASSETS_AND_LIABILITIES: AssetsAndLiabilities = {
    users_balance: 2_847_500,
    lnds: [
        {
            pubkey: "02abc123def456789012345678901234567890123456789012345678901234abcd",
            tracked: {
                confirmed_balance: 1_200_000,
                unconfirmed_balance: 50_000,
                channels_balance: 3_500_000,
                invoices: [
                    { amount: 100_000, ts: now - 2 * anHour, tracked: { amount: 100_000 + 50, ts: now - 2 * anHour, type: TrackedOperationType.USER } },
                    { amount: 75_000, ts: now - 1 * aDay, tracked: { amount: 75_000, ts: now - 1 * aDay - 5, type: TrackedOperationType.ROOT } },
                ],
                payments: [
                    { amount: 30_000, ts: now - anHour, tracked: { amount: 30_000 - 10, ts: now - anHour + 1, type: TrackedOperationType.USER } },
                ],
                incoming_tx: [
                    { amount: 500_000, ts: now - 2 * aDay },
                ],
                outgoing_tx: [
                    { amount: 100_000, ts: now - 4 * anHour, tracked: { amount: 100_000, ts: now - 4 * anHour + 4, type: TrackedOperationType.ROOT } },
                ],
            },
        },
        {
            pubkey: "03fedcba9876543210fedcba9876543210fedcba9876543210fedcba9876543210",
        },
    ],
    liquidity_providers: [
        {
            pubkey: "04lp1111111111111111111111111111111111111111111111111111111111111111",
            tracked: {
                balance: 5_200_000,
                invoices: [
                    { amount: 1_000_000, ts: now - anHour, tracked: { amount: 1_000_000, ts: now - anHour + 1, type: TrackedOperationType.USER } },
                    { amount: 500_000, ts: now - 12 * anHour, tracked: { amount: 500_000 + 20, ts: now - 12 * anHour, type: TrackedOperationType.USER } },
                    { amount: 750_000, ts: now - 2 * aDay, tracked: { amount: 750_000, ts: now - 2 * aDay + 3, type: TrackedOperationType.USER } },
                ],
                payments: [
                    { amount: 200_000, ts: now - 4 * anHour, tracked: { amount: 200_000, ts: now - 4 * anHour + 1, type: TrackedOperationType.ROOT } },
                    { amount: 50_000, ts: now - 1 * aDay, tracked: { amount: 50_000, ts: now - 1 * aDay, type: TrackedOperationType.USER } },
                    { amount: 100_000, ts: now - 2 * aDay },
                ],
            },
        },
        {
            pubkey: "05lp2222222222222222222222222222222222222222222222222222222222222222",
        },
    ],
}; */

function formatSats(n: number): string {
    return n.toLocaleString() + " sats";
}

function formatTs(unix: number): string {
    if (!unix) return "—";
    return new Date(unix * 1000).toLocaleString();
}

function trackedTypeLabel(type: TrackedOperationType): string {
    return type === TrackedOperationType.ROOT ? "ROOT" : "USER";
}

function hasDiscrepancy(op: AssetOperation): boolean {
    if (!op.tracked) return false;
    return op.amount !== op.tracked.amount || op.ts !== op.tracked.ts;
}

function getMismatch(op: AssetOperation): { amount: boolean; ts: boolean } | null {
    if (!op.tracked) return null;
    const amount = op.amount !== op.tracked.amount;
    const ts = op.ts !== op.tracked.ts;
    if (!amount && !ts) return null;
    return { amount, ts };
}

type LndOpType = "invoice" | "payment" | "incoming_tx" | "outgoing_tx";
type LpOpType = "invoice" | "payment";

const LND_OP_ICON: Record<LndOpType, typeof receiptOutline> = {
    invoice: receiptOutline,
    payment: sendOutline,
    incoming_tx: arrowDownOutline,
    outgoing_tx: arrowUpOutline,
};
const LND_OP_LABEL: Record<LndOpType, string> = {
    invoice: "Invoice",
    payment: "Payment",
    incoming_tx: "Incoming tx",
    outgoing_tx: "Outgoing tx",
};
const LND_OP_COLOR: Record<LndOpType, string> = {
    invoice: "var(--ion-color-success)",
    payment: "var(--ion-color-danger)",
    incoming_tx: "var(--ion-color-success)",
    outgoing_tx: "var(--ion-color-danger)",
};
const LP_OP_ICON: Record<LpOpType, typeof receiptOutline> = {
    invoice: receiptOutline,
    payment: sendOutline,
};
const LP_OP_COLOR: Record<LpOpType, string> = {
    invoice: "var(--ion-color-success)",
    payment: "var(--ion-color-danger)",
};

function LndAssetCard({ provider }: { provider: LndAssetProvider }) {
    const tracked = provider.tracked;
    if (!tracked) {
        return (
            <IonCard>
                <IonCardHeader>
                    <IonCardTitle style={{ fontSize: "1rem" }}>
                        <IonIcon icon={flashOutline} style={{ marginRight: "8px" }} />
                        LND — {provider.pubkey.slice(0, 12)}…
                    </IonCardTitle>
                </IonCardHeader>
                <IonCardContent>
                    <IonText color="medium">No tracked data</IonText>
                </IonCardContent>
            </IonCard>
        );
    }
    const total =
        tracked.confirmed_balance +
        tracked.unconfirmed_balance +
        tracked.channels_balance;
    const opsWithType: { op: AssetOperation; type: LndOpType }[] = [
        ...tracked.invoices.map((op) => ({ op, type: "invoice" as LndOpType })),
        ...tracked.payments.map((op) => ({ op, type: "payment" as LndOpType })),
        ...tracked.incoming_tx.map((op) => ({ op, type: "incoming_tx" as LndOpType })),
        ...tracked.outgoing_tx.map((op) => ({ op, type: "outgoing_tx" as LndOpType })),
    ].sort((a, b) => b.op.ts - a.op.ts);

    return (
        <IonCard>
            <IonCardHeader>
                <IonCardTitle style={{ fontSize: "1rem" }}>
                    <IonIcon icon={flashOutline} style={{ marginRight: "8px" }} />
                    LND — {provider.pubkey.slice(0, 12)}…
                </IonCardTitle>
            </IonCardHeader>
            <IonCardContent>
                <div style={{ display: "flex", flexDirection: "column", gap: "12px" }}>
                    <div
                        style={{
                            padding: "12px",
                            background: "var(--ion-color-light)",
                            borderRadius: "8px",
                        }}
                    >
                        <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "6px" }}>
                            <IonText color="medium">Confirmed</IonText>
                            <IonText><strong>{formatSats(tracked.confirmed_balance)}</strong></IonText>
                        </div>
                        <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "6px" }}>
                            <IonText color="medium">Unconfirmed</IonText>
                            <IonText><strong>{formatSats(tracked.unconfirmed_balance)}</strong></IonText>
                        </div>
                        <div style={{ display: "flex", justifyContent: "space-between" }}>
                            <IonText color="medium">Channels</IonText>
                            <IonText><strong>{formatSats(tracked.channels_balance)}</strong></IonText>
                        </div>
                        <div
                            style={{
                                marginTop: "8px",
                                paddingTop: "8px",
                                borderTop: "1px solid var(--ion-color-medium-tint)",
                                display: "flex",
                                justifyContent: "space-between",
                            }}
                        >
                            <IonText><strong>Total</strong></IonText>
                            <IonText color="primary"><strong>{formatSats(total)}</strong></IonText>
                        </div>
                    </div>
                    {opsWithType.length > 0 && (
                        <>
                            <IonText color="medium" style={{ fontSize: "0.9rem" }}>
                                Recent operations ({opsWithType.length})
                            </IonText>
                            <IonList lines="none" style={{ marginTop: "4px" }}>
                                {opsWithType.slice(0, 10).map(({ op, type }, i) => {
                                    const isTracked = op.tracked != null;
                                    const discrepancy = hasDiscrepancy(op);
                                    const mismatch = getMismatch(op);
                                    return (
                                        <IonItem
                                            key={i}
                                            style={
                                                !isTracked
                                                    ? { background: "var(--ion-color-warning-tint)", borderRadius: "6px", marginBottom: "4px" }
                                                    : discrepancy
                                                        ? { background: "rgba(var(--ion-color-danger-rgb), 0.08)", borderRadius: "6px", marginBottom: "4px" }
                                                        : undefined
                                            }
                                        >
                                            <IonIcon icon={LND_OP_ICON[type]} slot="start" style={{ marginRight: "8px", color: LND_OP_COLOR[type] }} title={LND_OP_LABEL[type]} />
                                            <IonLabel>
                                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                                    <span>{formatSats(op.amount)}</span>
                                                    <span style={{ fontSize: "0.75rem", color: "var(--ion-color-medium)" }}>
                                                        {formatTs(op.ts)}
                                                    </span>
                                                </div>
                                                {mismatch && op.tracked && (
                                                    <div style={{ fontSize: "0.7rem", color: "var(--ion-color-danger)", marginTop: "4px" }}>
                                                        {mismatch.amount && (
                                                            <div>Amount: root {formatSats(op.amount)} → tracked {formatSats(op.tracked.amount)}</div>
                                                        )}
                                                        {mismatch.ts && (
                                                            <div>Time: root {formatTs(op.ts)} → tracked {formatTs(op.tracked.ts)}</div>
                                                        )}
                                                    </div>
                                                )}
                                            </IonLabel>
                                            <div slot="end" style={{ display: "flex", flexDirection: "column", alignItems: "flex-end", gap: "2px", marginLeft: "8px" }}>
                                                {isTracked ? (
                                                    <>
                                                        <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
                                                            <IonIcon icon={checkmarkCircleOutline} style={{ color: "var(--ion-color-success)" }} title="Tracked" />
                                                            <IonText color="success" style={{ fontSize: "0.75rem" }}>
                                                                Tracked ({trackedTypeLabel(op.tracked!.type)})
                                                            </IonText>
                                                        </div>
                                                        {mismatch && (
                                                            <IonText color="danger" style={{ fontSize: "0.65rem" }}>
                                                                {mismatch.amount && mismatch.ts ? "Amount + time mismatch" : mismatch.amount ? "Amount mismatch" : "Time mismatch"}
                                                            </IonText>
                                                        )}
                                                    </>
                                                ) : (
                                                    <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
                                                        <IonIcon icon={alertCircleOutline} style={{ color: "var(--ion-color-warning)" }} title="Untracked" />
                                                        <IonText color="warning" style={{ fontSize: "0.75rem", fontWeight: 600 }}>Untracked</IonText>
                                                    </div>
                                                )}
                                            </div>
                                        </IonItem>
                                    );
                                })}
                            </IonList>
                        </>
                    )}
                </div>
            </IonCardContent>
        </IonCard>
    );
}

function LiquidityAssetCard({ provider }: { provider: LiquidityAssetProvider }) {
    const tracked = provider.tracked;
    if (!tracked) {
        return (
            <IonCard>
                <IonCardHeader>
                    <IonCardTitle style={{ fontSize: "1rem" }}>
                        <IonIcon icon={linkOutline} style={{ marginRight: "8px" }} />
                        LP — {provider.pubkey.slice(0, 12)}…
                    </IonCardTitle>
                </IonCardHeader>
                <IonCardContent>
                    <IonText color="medium">No tracked data</IonText>
                </IonCardContent>
            </IonCard>
        );
    }
    const opsWithType: { op: AssetOperation; type: LpOpType }[] = [
        ...tracked.invoices.map((op) => ({ op, type: "invoice" as LpOpType })),
        ...tracked.payments.map((op) => ({ op, type: "payment" as LpOpType })),
    ].sort((a, b) => b.op.ts - a.op.ts);

    return (
        <IonCard>
            <IonCardHeader>
                <IonCardTitle style={{ fontSize: "1rem" }}>
                    <IonIcon icon={linkOutline} style={{ marginRight: "8px" }} />
                    LP — {provider.pubkey.slice(0, 12)}…
                </IonCardTitle>
            </IonCardHeader>
            <IonCardContent>
                <div style={{ display: "flex", flexDirection: "column", gap: "12px" }}>
                    <div
                        style={{
                            padding: "12px",
                            background: "var(--ion-color-light)",
                            borderRadius: "8px",
                        }}
                    >
                        <div style={{ display: "flex", justifyContent: "space-between" }}>
                            <IonText color="medium">Balance</IonText>
                            <IonText color="primary"><strong>{formatSats(tracked.balance)}</strong></IonText>
                        </div>
                    </div>
                    {opsWithType.length > 0 && (
                        <>
                            <IonText color="medium" style={{ fontSize: "0.9rem" }}>
                                Invoices & payments ({opsWithType.length})
                            </IonText>
                            <IonList lines="none" style={{ marginTop: "4px" }}>
                                {opsWithType.slice(0, 10).map(({ op, type }, i) => {
                                    const isTracked = op.tracked != null;
                                    const discrepancy = hasDiscrepancy(op);
                                    const mismatch = getMismatch(op);
                                    return (
                                        <IonItem
                                            key={i}
                                            style={
                                                !isTracked
                                                    ? { background: "var(--ion-color-warning-tint)", borderRadius: "6px", marginBottom: "4px" }
                                                    : discrepancy
                                                        ? { background: "rgba(var(--ion-color-danger-rgb), 0.08)", borderRadius: "6px", marginBottom: "4px" }
                                                        : undefined
                                            }
                                        >
                                            <IonIcon icon={LP_OP_ICON[type]} slot="start" style={{ marginRight: "8px", color: LP_OP_COLOR[type] }} title={type === "invoice" ? "Invoice" : "Payment"} />
                                            <IonLabel>
                                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                                    <span>{formatSats(op.amount)}</span>
                                                    <span style={{ fontSize: "0.75rem", color: "var(--ion-color-medium)" }}>
                                                        {formatTs(op.ts)}
                                                    </span>
                                                </div>
                                                {mismatch && op.tracked && (
                                                    <div style={{ fontSize: "0.7rem", color: "var(--ion-color-danger)", marginTop: "4px" }}>
                                                        {mismatch.amount && (
                                                            <div>Amount: root {formatSats(op.amount)} → tracked {formatSats(op.tracked.amount)}</div>
                                                        )}
                                                        {mismatch.ts && (
                                                            <div>Time: root {formatTs(op.ts)} → tracked {formatTs(op.tracked.ts)}</div>
                                                        )}
                                                    </div>
                                                )}
                                            </IonLabel>
                                            <div slot="end" style={{ display: "flex", flexDirection: "column", alignItems: "flex-end", gap: "2px", marginLeft: "8px" }}>
                                                {isTracked ? (
                                                    <>
                                                        <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
                                                            <IonIcon icon={checkmarkCircleOutline} style={{ color: "var(--ion-color-success)" }} title="Tracked" />
                                                            <IonText color="success" style={{ fontSize: "0.75rem" }}>
                                                                Tracked ({trackedTypeLabel(op.tracked!.type)})
                                                            </IonText>
                                                        </div>
                                                        {mismatch && (
                                                            <IonText color="danger" style={{ fontSize: "0.65rem" }}>
                                                                {mismatch.amount && mismatch.ts ? "Amount + time mismatch" : mismatch.amount ? "Amount mismatch" : "Time mismatch"}
                                                            </IonText>
                                                        )}
                                                    </>
                                                ) : (
                                                    <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
                                                        <IonIcon icon={alertCircleOutline} style={{ color: "var(--ion-color-warning)" }} title="Untracked" />
                                                        <IonText color="warning" style={{ fontSize: "0.75rem", fontWeight: 600 }}>Untracked</IonText>
                                                    </div>
                                                )}
                                            </div>
                                        </IonItem>
                                    );
                                })}
                            </IonList>
                        </>
                    )}
                </div>
            </IonCardContent>
        </IonCard>
    );
}

export const AssetsAndLiab = () => {
    const router = useIonRouter();
    const admins = useAppSelector(selectAdminNprofileViews);
    const selectedId = useAppSelector(selectSelectedMetricsAdminSourceId);
    const adminSource = useMemo(
        () => admins.find(a => a.sourceId === selectedId),
        [admins, selectedId]
    );
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [limitInvoices, setLimitInvoices] = useState<number>(0);
    const [limitPayments, setLimitPayments] = useState<number>(0);
    const [limitLiquidityProviders, setLimitLiquidityProviders] = useState<number>(0);
    const [assetsAndLiabilities, setAssetsAndLiabilities] = useState<AssetsAndLiabilities>({ liquidity_providers: [], lnds: [], users_balance: 0 });
    const [presentLoading, dismissLoading] = useIonLoading();

    const fetch = <T extends readonly unknown[]>(funcs: FetcherFuncs<T>, loadingMessage: string) => {
        if (!adminSource) return;
        return fetcher({ pubkey: adminSource.lpk, relays: adminSource.relays }, adminSource.keys, {
            onStart: async () => { setError(null); setLoading(true); await dismissLoading(); await presentLoading(loadingMessage); },
            onEnd: async () => { setLoading(false); await dismissLoading(); },
            onFail: (err) => { setError(err); toast.error(err); },
        }, funcs);
    };

    const fetchAssetsAndLiabilities = async () => {
        const req: AssetsAndLiabilitiesReq = {
            limit_invoices: limitInvoices || undefined,
            limit_payments: limitPayments || undefined,
            limit_providers: limitLiquidityProviders || undefined,
        };
        const res = await fetch([(client) => client.GetAssetsAndLiabilities(req)], "Fetching assets and liabilities...");
        if (!res) return;
        const [data] = res;
        if (data && data.status === "OK") {
            setAssetsAndLiabilities(data);
            console.log(data);
        }
    };

    useEffect(() => {
        fetchAssetsAndLiabilities();
    }, [adminSource?.sourceId]);

    const totalAssets = useMemo(() => {
        let sum = 0;
        for (const lnd of assetsAndLiabilities.lnds) {
            if (lnd.tracked) {
                sum +=
                    lnd.tracked.confirmed_balance +
                    lnd.tracked.unconfirmed_balance +
                    lnd.tracked.channels_balance;
            }
        }
        for (const lp of assetsAndLiabilities.liquidity_providers) {
            if (lp.tracked) sum += lp.tracked.balance;
        }
        return sum;
    }, [assetsAndLiabilities]);

    return (
        <IonPage className="ion-page-width">
            <IonHeader className="ion-no-border">
                <MetricsSubPageToolbar title="Assets & Liabilities" />
            </IonHeader>
            <IonContent className="ion-padding ion-content-no-footer">
                {error && (
                    <div
                        style={{
                            padding: 12,
                            marginBottom: 12,
                            background: "var(--ion-color-danger-tint)",
                            borderRadius: "8px",
                            color: "var(--ion-color-danger-shade)",
                            border: "1px solid var(--ion-color-danger)",
                        }}
                    >
                        <div style={{ fontWeight: 700, marginBottom: 8 }}>Something went wrong</div>
                        <div style={{ marginBottom: 12 }}>{error}</div>
                        <div style={{ display: "flex", gap: 8 }}>
                            <IonButton onClick={() => void fetchAssetsAndLiabilities()}>Retry</IonButton>
                            <IonButton fill="outline" onClick={() => router.push("/metrics/select", "back")}>
                                Change Source
                            </IonButton>
                        </div>
                    </div>
                )}

                {!error && (
                    <>
                        <IonCard>
                            <IonCardHeader>
                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                    <IonCardTitle>Summary</IonCardTitle>
                                    <IonButton size="small" fill="outline" onClick={() => void fetchAssetsAndLiabilities()}>
                                        Refresh
                                    </IonButton>
                                </div>
                            </IonCardHeader>
                            <IonCardContent>
                                <div
                                    style={{
                                        display: "flex",
                                        flexDirection: "column",
                                        gap: "12px",
                                        padding: "12px",
                                        background: "var(--ion-color-light)",
                                        borderRadius: "8px",
                                    }}
                                >
                                    {/* Proportional bar: red = liabilities, green = assets */}
                                    {(() => {
                                        const liabilities = assetsAndLiabilities.users_balance;
                                        const assets = totalAssets;
                                        const total = liabilities + assets;
                                        const liabilityPct = total > 0 ? (liabilities / total) * 100 : 50;
                                        const assetPct = total > 0 ? (assets / total) * 100 : 50;
                                        const diff = Math.abs(assets - liabilities);
                                        return (
                                            <>
                                                <div
                                                    style={{
                                                        display: "flex",
                                                        alignItems: "stretch",
                                                        height: "28px",
                                                        borderRadius: "8px",
                                                        overflow: "hidden",
                                                        boxShadow: "inset 0 1px 2px rgba(0,0,0,0.1)",
                                                    }}
                                                >
                                                    <div
                                                        style={{
                                                            width: `${liabilityPct}%`,
                                                            minWidth: total === 0 ? "50%" : liabilityPct < 2 ? "0" : undefined,
                                                            background: "var(--ion-color-danger)",
                                                        }}
                                                        title={formatSats(liabilities)}
                                                    />
                                                    <div
                                                        style={{
                                                            width: "3px",
                                                            flexShrink: 0,
                                                            background: "var(--ion-color-dark)",
                                                            opacity: 0.8,
                                                        }}
                                                    />
                                                    <div
                                                        style={{
                                                            width: `${assetPct}%`,
                                                            minWidth: total === 0 ? "50%" : assetPct < 2 ? "0" : undefined,
                                                            background: "var(--ion-color-success)",
                                                        }}
                                                        title={formatSats(assets)}
                                                    />
                                                </div>
                                                <div style={{ display: "flex", justifyContent: "space-between", fontSize: "0.9rem" }}>
                                                    <IonText color="danger">
                                                        <IonIcon icon={peopleOutline} style={{ marginRight: "4px", verticalAlign: "middle" }} />
                                                        <strong>{formatSats(liabilities)}</strong> liability
                                                    </IonText>
                                                    <IonText color="success">
                                                        <strong>{formatSats(assets)}</strong> assets
                                                        <IonIcon icon={walletOutline} style={{ marginLeft: "4px", verticalAlign: "middle" }} />
                                                    </IonText>
                                                </div>
                                                <div style={{ textAlign: "center", fontSize: "0.85rem" }}>
                                                    {total === 0 ? (
                                                        <IonText color="medium">No data</IonText>
                                                    ) : assets > liabilities ? (
                                                        <IonText color="success">
                                                            Assets exceed liabilities by <strong>{formatSats(diff)}</strong>
                                                        </IonText>
                                                    ) : liabilities > assets ? (
                                                        <IonText color="danger">
                                                            Liabilities exceed assets by <strong>{formatSats(diff)}</strong>
                                                        </IonText>
                                                    ) : (
                                                        <IonText color="medium">Assets and liabilities are equal</IonText>
                                                    )}
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </IonCardContent>
                        </IonCard>

                        <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                            <IonIcon icon={flashOutline} style={{ marginRight: "8px" }} />
                            LND assets
                        </IonText>
                        {assetsAndLiabilities.lnds.length === 0 && (
                            <IonCard>
                                <IonCardContent style={{ textAlign: "center", padding: "24px" }}>
                                    <IonIcon icon={flashOutline} style={{ fontSize: "48px", color: "var(--ion-color-medium)", marginBottom: "8px" }} />
                                    <IonText color="medium">No LND providers</IonText>
                                </IonCardContent>
                            </IonCard>
                        )}
                        {assetsAndLiabilities.lnds.map((lnd, i) => (
                            <LndAssetCard key={lnd.pubkey + i} provider={lnd} />
                        ))}

                        <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                            <IonIcon icon={linkOutline} style={{ marginRight: "8px" }} />
                            Liquidity provider assets
                        </IonText>
                        {assetsAndLiabilities.liquidity_providers.length === 0 && (
                            <IonCard>
                                <IonCardContent style={{ textAlign: "center", padding: "24px" }}>
                                    <IonIcon icon={linkOutline} style={{ fontSize: "48px", color: "var(--ion-color-medium)", marginBottom: "8px" }} />
                                    <IonText color="medium">No liquidity providers</IonText>
                                </IonCardContent>
                            </IonCard>
                        )}
                        {assetsAndLiabilities.liquidity_providers.map((lp, i) => (
                            <LiquidityAssetCard key={lp.pubkey + i} provider={lp} />
                        ))}
                    </>
                )}
            </IonContent>
        </IonPage>
    );
};