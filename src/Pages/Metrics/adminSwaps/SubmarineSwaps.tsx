import { useEffect, useMemo, useState } from "react"
import { Period } from "@/Components/Dropdowns/LVDropdown"
import { toast } from "react-toastify";
import * as Types from '../../../Api/pub/autogenerated/ts/types';
import { IonButton, IonContent, IonItem, IonPage, IonHeader, useIonLoading, useIonRouter, IonRow, IonText, IonInput, IonBadge, IonCard, IonCardContent, IonCardHeader, IonCardTitle, IonLabel, IonIcon } from "@ionic/react";
import { flashOutline, linkOutline, personOutline, checkmarkCircle, closeCircle, timeOutline, walletOutline, alertCircle, cashOutline } from "ionicons/icons";
import MetricsSubPageToolbar from "@/Layout2/Metrics/MetricsSubPageToolbar";
import { useAppSelector } from "@/State/store/hooks";
import { NprofileView, selectAdminNprofileViews } from "@/State/scoped/backups/sources/selectors";
import { selectSelectedMetricsAdminSourceId } from "@/State/runtime/slice";
import { InvoiceSwapsList, InvoiceSwapQuote, InvoiceSwapOperation } from "../../../Api/pub/autogenerated/ts/types";
import { fetcher, FetcherFuncs } from "../fetcher";
import AmountInput from "@/Components/AmountInput";
const currentBlock = 1000000;
const pendingUnpaidQueote: InvoiceSwapQuote = {
    swap_operation_id: "1",
    service_url: "https://example.com",
    invoice_amount_sats: 1000,
    transaction_amount_sats: 1100,
    address: "tx_address_1",
    chain_fee_sats: 0,
    invoice: "lnbc1000",
    service_fee_sats: 0,
    swap_fee_sats: 50, // expected fee, actual fee is tx_amount - invoice_amount
    tx_id: "", // not started yet
    paid_at_unix: 0,
    expires_at_block_height: currentBlock + 100,
}
const pendingPaidQuote: InvoiceSwapQuote = {
    swap_operation_id: "2",
    service_url: "https://example.com",
    invoice_amount_sats: 1000,
    transaction_amount_sats: 1100,
    address: "tx_address_2",
    chain_fee_sats: 10,
    invoice: "lnbc1000",
    service_fee_sats: 0,
    swap_fee_sats: 50, // expected fee, actual fee is tx_amount - invoice_amount
    tx_id: "tx_id_2",
    paid_at_unix: Math.floor(Date.now() / 1000) - 60,
    expires_at_block_height: currentBlock + 50,
}
const expiredPaidQuote: InvoiceSwapQuote = {
    swap_operation_id: "3",
    service_url: "https://example.com",
    invoice_amount_sats: 1000,
    transaction_amount_sats: 1100,
    address: "tx_address_3",
    chain_fee_sats: 10,
    invoice: "lnbc1000",
    service_fee_sats: 0,
    swap_fee_sats: 50, // expected fee, actual fee is tx_amount - invoice_amount
    tx_id: "tx_id_3",
    paid_at_unix: Math.floor(Date.now() / 1000) - 60 * 60 * 2,
    expires_at_block_height: currentBlock - 10, // expired
}
const completedSwap: InvoiceSwapOperation = {
    quote: {
        swap_operation_id: "101",
        service_url: "https://example.com",
        invoice_amount_sats: 1000,
        transaction_amount_sats: 1100,
        address: "tx_address_101",
        chain_fee_sats: 0,
        invoice: "lnbc1000",
        service_fee_sats: 0,
        swap_fee_sats: 50, // expected fee, actual fee is tx_amount - invoice_amount
        tx_id: "tx_id_101",
        paid_at_unix: Math.floor(Date.now() / 1000) - 60 * 60 * 2,
        expires_at_block_height: currentBlock + 30,
    },
    completed_at_unix: Math.floor(Date.now() / 1000) - 60 * 60,
    failure_reason: "",
}
const failedSwap: InvoiceSwapOperation = {
    quote: {
        swap_operation_id: "102",
        service_url: "https://example.com",
        invoice_amount_sats: 1000,
        transaction_amount_sats: 1100,
        address: "tx_address_102",
        chain_fee_sats: 10,
        invoice: "lnbc1000",
        service_fee_sats: 0,
        swap_fee_sats: 50, // expected fee, actual fee is tx_amount - invoice_amount
        tx_id: "tx_id_102",
        paid_at_unix: Math.floor(Date.now() / 1000) - 60 * 60 * 2.5,
        expires_at_block_height: currentBlock + 20,
    },
    completed_at_unix: Math.floor(Date.now() / 1000) - 60 * 60 * 1.5,
    failure_reason: "failed to swap",
}
const failedExpiredSwap: InvoiceSwapOperation = {
    quote: {
        swap_operation_id: "103",
        service_url: "https://example.com",
        invoice_amount_sats: 1000,
        transaction_amount_sats: 1100,
        address: "tx_address_103",
        chain_fee_sats: 10,
        invoice: "lnbc1000",
        service_fee_sats: 0,
        swap_fee_sats: 50, // expected fee, actual fee is tx_amount - invoice_amount
        tx_id: "tx_id_103",
        paid_at_unix: Math.floor(Date.now() / 1000) - 60 * 60 * 26,
        expires_at_block_height: currentBlock - 10, // expired
    },
    completed_at_unix: Math.floor(Date.now() / 1000) - 60 * 60 * 24,
    failure_reason: "expired",
}
const testData: InvoiceSwapsList = {
    current_block_height: currentBlock,
    swaps: [completedSwap, failedSwap, failedExpiredSwap, { quote: pendingUnpaidQueote }, { quote: pendingPaidQuote }, { quote: expiredPaidQuote }],
}

type SwapStatus =
    | 'unpaid_quote'
    | 'paid_pending'
    | 'expired_paid_quote'
    | 'completed'
    | 'failed'
    | 'failed_expired';

interface CategorizedSwap {
    operation: InvoiceSwapOperation;
    status: SwapStatus;
    isRefundable: boolean;
    isExpired: boolean;
}

function getSwapStatus(operation: InvoiceSwapOperation, currentBlockHeight: number): CategorizedSwap {
    const { quote, completed_at_unix, failure_reason } = operation;
    const isPaid = quote.tx_id !== "";
    const isExpired = currentBlockHeight > quote.expires_at_block_height;
    const isCompleted = completed_at_unix !== undefined && completed_at_unix > 0;
    const hasFailed = failure_reason !== undefined && failure_reason !== "";

    // Determine status
    let status: SwapStatus;
    if (isCompleted && !hasFailed) {
        status = 'completed';
    } else if (isCompleted && hasFailed && isExpired) {
        status = 'failed_expired';
    } else if (isCompleted && hasFailed) {
        status = 'failed';
    } else if (isPaid && isExpired) {
        status = 'expired_paid_quote';
    } else if (isPaid) {
        status = 'paid_pending';
    } else {
        status = 'unpaid_quote';
    }

    // Only paid expired swaps and quotes are refundable
    const isRefundable = isPaid && isExpired;

    return { operation, status, isRefundable, isExpired };
}

function getStatusLabel(status: SwapStatus): string {
    switch (status) {
        case 'unpaid_quote': return 'Unpaid Quote';
        case 'paid_pending': return 'Paid - Pending';
        case 'expired_paid_quote': return 'Expired (Refundable)';
        case 'completed': return 'Completed';
        case 'failed': return 'Failed';
        case 'failed_expired': return 'Failed & Expired (Refundable)';
    }
}

function getStatusColor(status: SwapStatus): string {
    switch (status) {
        case 'unpaid_quote': return 'medium';
        case 'paid_pending': return 'primary';
        case 'expired_paid_quote': return 'warning';
        case 'completed': return 'success';
        case 'failed': return 'danger';
        case 'failed_expired': return 'warning';
    }
}

function getStatusIcon(status: SwapStatus) {
    switch (status) {
        case 'unpaid_quote': return walletOutline;
        case 'paid_pending': return timeOutline;
        case 'expired_paid_quote': return alertCircle;
        case 'completed': return checkmarkCircle;
        case 'failed': return closeCircle;
        case 'failed_expired': return alertCircle;
    }
}

function formatTimestamp(unix: number): string {
    if (!unix || unix === 0) return 'N/A';
    return new Date(unix * 1000).toLocaleString();
}

function formatTimeAgo(unix: number): string {
    if (!unix || unix === 0) return 'N/A';
    const now = Date.now() / 1000;
    const diff = now - unix;

    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} hrs ago`;
    return `${Math.floor(diff / 86400)} days ago`;
}

interface SwapCardProps {
    swap: CategorizedSwap;
    refundingOp: string | null;
    setRefundingOp: (opId: string | null) => void;
    refundSatPerVByte: number;
    setRefundSatPerVByte: (val: number) => void;
    refundSwap: () => void;
    doSwap: (opId: string) => void;
}

function SwapCard({ swap, refundingOp, setRefundingOp, refundSatPerVByte, setRefundSatPerVByte, refundSwap, doSwap }: SwapCardProps) {
    const { operation, status, isRefundable, isExpired } = swap;
    const { quote, completed_at_unix, failure_reason } = operation;
    const isRefunding = refundingOp === quote.swap_operation_id;

    return (
        <IonCard style={{
            border: isRefundable ? '2px solid var(--ion-color-warning)' : undefined,
            boxShadow: isRefundable ? '0 4px 12px rgba(255, 193, 7, 0.2)' : undefined
        }}>
            <IonCardHeader>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px' }}>
                    <IonCardTitle style={{ fontSize: '1rem' }}>
                        {quote.service_url}
                    </IonCardTitle>
                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                        <IonBadge color={getStatusColor(status)}>
                            <IonIcon icon={getStatusIcon(status)} style={{ marginRight: '4px' }} />
                            {getStatusLabel(status)}
                        </IonBadge>
                        {isRefundable && (
                            <IonBadge color="warning">
                                <IonIcon icon={cashOutline} style={{ marginRight: '4px' }} />
                                Refundable
                            </IonBadge>
                        )}
                    </div>
                </div>
            </IonCardHeader>
            <IonCardContent>
                {/* Timeline visualization */}
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    marginBottom: '16px',
                    padding: '12px',
                    background: 'var(--ion-color-light)',
                    borderRadius: '8px'
                }}>
                    <div style={{ flex: 1, textAlign: 'center' }}>
                        <IonIcon
                            icon={walletOutline}
                            style={{ fontSize: '24px', color: status !== 'unpaid_quote' ? 'var(--ion-color-success)' : 'var(--ion-color-medium)' }}
                        />
                        <div style={{ fontSize: '0.7rem', marginTop: '4px', fontWeight: 'bold' }}>Quote</div>
                        <div style={{ fontSize: '0.6rem', color: 'var(--ion-color-medium)' }}>Created</div>
                    </div>
                    <div style={{ flex: 0.5, height: '2px', background: quote.paid_at_unix > 0 ? 'var(--ion-color-success)' : 'var(--ion-color-medium)' }} />
                    <div style={{ flex: 1, textAlign: 'center' }}>
                        <IonIcon
                            icon={cashOutline}
                            style={{ fontSize: '24px', color: quote.paid_at_unix > 0 ? 'var(--ion-color-success)' : 'var(--ion-color-medium)' }}
                        />
                        <div style={{ fontSize: '0.7rem', marginTop: '4px', fontWeight: 'bold' }}>Paid</div>
                        <div style={{ fontSize: '0.6rem', color: 'var(--ion-color-medium)' }}>
                            {quote.paid_at_unix > 0 ? formatTimeAgo(quote.paid_at_unix) : 'Pending'}
                        </div>
                    </div>
                    <div style={{ flex: 0.5, height: '2px', background: completed_at_unix ? 'var(--ion-color-success)' : 'var(--ion-color-medium)' }} />
                    <div style={{ flex: 1, textAlign: 'center' }}>
                        <IonIcon
                            icon={completed_at_unix && !failure_reason ? checkmarkCircle : completed_at_unix && failure_reason ? closeCircle : timeOutline}
                            style={{
                                fontSize: '24px',
                                color: completed_at_unix && !failure_reason ? 'var(--ion-color-success)' :
                                    completed_at_unix && failure_reason ? 'var(--ion-color-danger)' :
                                        'var(--ion-color-medium)'
                            }}
                        />
                        <div style={{ fontSize: '0.7rem', marginTop: '4px', fontWeight: 'bold' }}>
                            {completed_at_unix && !failure_reason ? 'Complete' : completed_at_unix && failure_reason ? 'Failed' : 'Processing'}
                        </div>
                        <div style={{ fontSize: '0.6rem', color: 'var(--ion-color-medium)' }}>
                            {completed_at_unix ? formatTimeAgo(completed_at_unix) : 'Waiting'}
                        </div>
                    </div>
                </div>

                {/* Details */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <IonText color="medium">Invoice Amount:</IonText>
                        <IonText><strong>{quote.invoice_amount_sats.toLocaleString()} sats</strong></IonText>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <IonText color="medium">Transaction Amount:</IonText>
                        <IonText><strong>{quote.transaction_amount_sats.toLocaleString()} sats</strong></IonText>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <IonText color="medium">Swap Fee:</IonText>
                        <IonText color="warning"><strong>{(quote.transaction_amount_sats - quote.invoice_amount_sats).toLocaleString()} sats</strong></IonText>
                    </div>
                    {quote.chain_fee_sats > 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <IonText color="medium">Chain Fee:</IonText>
                            <IonText><strong>{quote.chain_fee_sats.toLocaleString()} sats</strong></IonText>
                        </div>
                    )}
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <IonText color="medium">Expires at Block:</IonText>
                        <IonText color={isExpired ? "danger" : "success"}>
                            <strong>{quote.expires_at_block_height.toLocaleString()}</strong>
                            {isExpired && " (Expired)"}
                        </IonText>
                    </div>
                    {quote.tx_id && (
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <IonText color="medium">TX ID:</IonText>
                            <IonText style={{ fontSize: '0.8rem', fontFamily: 'monospace' }}>{quote.tx_id.substring(0, 16)}...</IonText>
                        </div>
                    )}
                    {failure_reason && (
                        <div style={{ marginTop: '8px', padding: '8px', /* background: 'var(--ion-color-danger-tint)', */ borderRadius: '4px' }}>
                            <IonText color="danger">
                                <strong>Failure Reason:</strong> {failure_reason}
                            </IonText>
                        </div>
                    )}
                    <div style={{ fontSize: '0.75rem', color: 'var(--ion-color-medium)', marginTop: '4px' }}>
                        <div>Address: {quote.address}</div>
                        <div>Operation ID: {quote.swap_operation_id}</div>
                    </div>
                </div>

                {/* Actions */}
                <div style={{ marginTop: '16px', display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    {!isRefunding && !quote.tx_id && status === 'unpaid_quote' && (
                        <IonButton size="small" onClick={() => doSwap(quote.swap_operation_id)}>
                            Pay Quote
                        </IonButton>
                    )}

                    {!isRefunding && isRefundable && (
                        <IonButton size="small" color="warning" onClick={() => setRefundingOp(quote.swap_operation_id)}>
                            <IonIcon icon={cashOutline} slot="start" />
                            Refund
                        </IonButton>
                    )}

                    {isRefunding && (
                        <>
                            <div style={{ width: '100%', display: 'flex', gap: '8px', alignItems: 'center' }}>
                                <IonInput
                                    label="Sat per vByte"
                                    type="number"
                                    value={refundSatPerVByte}
                                    onIonChange={(e) => setRefundSatPerVByte(Number(e.detail.value) || 0)}
                                    style={{ flex: 1 }}
                                />
                            </div>
                            <IonButton size="small" color="warning" onClick={refundSwap}>
                                Confirm Refund
                            </IonButton>
                            <IonButton size="small" fill="outline" onClick={() => setRefundingOp(null)}>
                                Cancel
                            </IonButton>
                        </>
                    )}
                </div>
            </IonCardContent>
        </IonCard>
    );
}

export default function SubmarineSwaps({ adminSource }: { adminSource: NprofileView | undefined }) {
    const router = useIonRouter();
    const [amountSats, setAmountSats] = useState<number>(0);
    const [satPerVByte, setSatPerVByte] = useState<number>(0);
    const [quotes, setQuotes] = useState<InvoiceSwapQuote[]>([]);
    const [refundingOp, setRefundingOp] = useState<string | null>(null);
    const [refundSatPerVByte, setRefundSatPerVByte] = useState<number>(0);
    // const [address, setAddress] = useState<string>("");

    const [swaps, setSwaps] = useState<InvoiceSwapsList>(testData);
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState<string | null>(null)

    const [presentLoading, dismissLoading] = useIonLoading();

    const fetch = <T extends readonly unknown[]>(funcs: FetcherFuncs<T>, loadingMessage: string) => {
        if (!adminSource) return;
        return fetcher({ pubkey: adminSource.lpk, relays: adminSource.relays }, adminSource.keys, {
            onStart: async () => { setError(null); setLoading(true); await dismissLoading(); await presentLoading(loadingMessage); },
            onEnd: async () => { setLoading(false); await dismissLoading(); },
            onFail: (error) => { setError(error); toast.error(error); },
        }, funcs)
    }


    useEffect(() => {
        fetchSwaps()
    }, [adminSource?.sourceId])

    const fetchSwaps = async () => {
        const res = await fetch([(client) => client.ListAdminInvoiceSwaps()], "Fetching swaps...")
        if (!res) return;
        const [swaps] = res
        // setSwaps(swaps);
    }
    const requestQuote = async () => {
        const res = await fetch([(client) => client.GetAdminInvoiceSwapQuotes({ amount_sats: amountSats })], "Fetching quotes...")
        if (!res) return;
        const [quote] = res
        setQuotes(quote.quotes);
    }

    const doSwap = async (swapOpId: string) => {
        if (!satPerVByte) {
            toast.error("No sat per v byte found");
            return;
        }
        const req: Types.PayAdminInvoiceSwapRequest = { sat_per_v_byte: satPerVByte, swap_operation_id: swapOpId }
        const res = await fetch([(client) => client.PayAdminInvoiceSwap(req)], "Doing swap...")
        if (!res) return;
        fetchSwaps();
    }
    const cancelSwap = () => {
        setQuotes([]);
        fetchSwaps();
    }

    const refundSwap = async () => {
        if (!refundingOp) {
            toast.error("No swap operation id found");
            return;
        }
        const req: Types.RefundAdminInvoiceSwapRequest = { sat_per_v_byte: refundSatPerVByte, swap_operation_id: refundingOp }
        const res = await fetch([(client) => client.RefundAdminInvoiceSwap(req)], "Refunding swap...")
        if (!res) return;
        setRefundingOp(null);
        fetchSwaps();
    }

    // Categorize all swaps
    const categorizedSwaps = useMemo(() => {
        return swaps.swaps.map(op => getSwapStatus(op, swaps.current_block_height));
    }, [swaps]);

    // Group by status
    const groupedSwaps = useMemo(() => {
        const groups: Record<SwapStatus, CategorizedSwap[]> = {
            unpaid_quote: [],
            paid_pending: [],
            expired_paid_quote: [],
            completed: [],
            failed: [],
            failed_expired: []
        };

        categorizedSwaps.forEach(swap => {
            groups[swap.status].push(swap);
        });

        return groups;
    }, [categorizedSwaps]);

    return <IonContent className="ion-padding ion-content-no-footer">
        {error && (
            <div style={{
                padding: 12,
                marginBottom: 12,
                background: 'var(--ion-color-danger-tint)',
                borderRadius: '8px',
                color: 'var(--ion-color-danger-shade)',
                border: '1px solid var(--ion-color-danger)',
            }}>
                <div style={{ fontWeight: 700, marginBottom: 8 }}>Something went wrong</div>
                <div style={{ marginBottom: 12 }}>{error}</div>
                <div style={{ display: "flex", gap: 8 }}>
                    <IonButton onClick={() => void fetchSwaps()}>Retry</IonButton>
                    <IonButton fill="outline" onClick={() => router.push("/metrics/select", "back")}>
                        Change Source
                    </IonButton>
                </div>
            </div>
        )}
        {quotes.length === 0 && (
            <IonCard>
                <IonCardHeader>
                    <IonCardTitle>Request New Swap Quote</IonCardTitle>
                </IonCardHeader>
                <IonCardContent>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        <IonText color="medium">
                            Enter the amount (in sats) you want to receive via Lightning invoice
                        </IonText>
                        <IonInput
                            label="Invoice Amount (sats)"
                            type="number"
                            value={amountSats}
                            onIonChange={(e) => setAmountSats(Number(e.detail.value) || 0)}
                            placeholder="e.g. 100000"
                        />
                        <IonButton
                            expand="block"
                            onClick={requestQuote}
                            disabled={!amountSats || amountSats <= 0}
                        >
                            <IonIcon icon={flashOutline} slot="start" />
                            Get Quotes from Services
                        </IonButton>
                    </div>
                </IonCardContent>
            </IonCard>
        )}
        {/* New quotes section */}
        {quotes.length > 0 && (
            <>
                <IonText className="ion-margin-top" style={{ fontSize: "1.4rem", fontWeight: "bold", display: "block", marginBottom: "12px" }}>
                    <IonIcon icon={flashOutline} style={{ marginRight: "8px" }} />
                    New Quotes Available
                </IonText>
                {quotes.map(quote => (
                    <IonCard key={quote.swap_operation_id} style={{ border: '2px solid var(--ion-color-primary)' }}>
                        <IonCardHeader>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <IonCardTitle style={{ fontSize: '1rem' }}>
                                    {quote.service_url}
                                </IonCardTitle>
                                <IonBadge color="primary">New Quote</IonBadge>
                            </div>
                        </IonCardHeader>
                        <IonCardContent>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                <div style={{
                                    padding: '12px',
                                    background: 'var(--ion-color-primary-tint)',
                                    borderRadius: '8px',
                                    marginBottom: '8px'
                                }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <IonText><strong>Invoice Amount:</strong></IonText>
                                        <IonText><strong>{quote.invoice_amount_sats.toLocaleString()} sats</strong></IonText>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <IonText><strong>You Send:</strong></IonText>
                                        <IonText><strong>{quote.transaction_amount_sats.toLocaleString()} sats</strong></IonText>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <IonText color="warning"><strong>Swap Fee:</strong></IonText>
                                        <IonText color="warning"><strong>{(quote.transaction_amount_sats - quote.invoice_amount_sats).toLocaleString()} sats</strong></IonText>
                                    </div>
                                </div>

                                <div style={{ fontSize: '0.85rem' }}>
                                    <div style={{ marginBottom: '4px' }}>
                                        <IonText color="medium">Destination Address:</IonText>
                                    </div>
                                    <div style={{
                                        padding: '8px',
                                        background: 'var(--ion-color-light)',
                                        borderRadius: '4px',
                                        fontFamily: 'monospace',
                                        fontSize: '0.75rem',
                                        wordBreak: 'break-all'
                                    }}>
                                        {quote.address}
                                    </div>
                                </div>

                                <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginTop: '8px' }}>
                                    <IonInput
                                        label="Sat per vByte"
                                        type="number"
                                        value={satPerVByte}
                                        onIonChange={(e) => setSatPerVByte(Number(e.detail.value) || 0)}
                                        placeholder="Enter fee rate"
                                        style={{ flex: 1 }}
                                    />
                                </div>

                                <IonButton
                                    expand="block"
                                    onClick={() => doSwap(quote.swap_operation_id)}
                                    disabled={!satPerVByte || satPerVByte <= 0}
                                >
                                    <IonIcon icon={flashOutline} slot="start" />
                                    Execute Swap
                                </IonButton>
                            </div>
                        </IonCardContent>
                    </IonCard>
                ))}
                <IonButton
                    expand="block"
                    fill="outline"
                    onClick={cancelSwap}
                    style={{ marginTop: '8px', marginBottom: '16px' }}
                >
                    Cancel & Request New Amount
                </IonButton>
            </>
        )}

        {/* Display swaps grouped by status */}
        <IonCard>
            <IonCardHeader>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <IonCardTitle>Swap Operations</IonCardTitle>
                    <IonButton size="small" fill="outline" onClick={() => void fetchSwaps()}>
                        Refresh
                    </IonButton>
                </div>
            </IonCardHeader>
            <IonCardContent>
                <IonText color="medium">
                    Current Block: {swaps.current_block_height.toLocaleString()}
                </IonText>
                {swaps.swaps.length > 0 && (
                    <div style={{ marginTop: '8px' }}>
                        <IonText color="medium" style={{ fontSize: '0.9rem' }}>
                            Total Operations: {swaps.swaps.length}
                        </IonText>
                    </div>
                )}
            </IonCardContent>
        </IonCard>

        {/* No swaps message */}
        {swaps.swaps.length === 0 && quotes.length === 0 && (
            <IonCard>
                <IonCardContent style={{ textAlign: 'center', padding: '32px' }}>
                    <IonIcon
                        icon={walletOutline}
                        style={{ fontSize: '64px', color: 'var(--ion-color-medium)', marginBottom: '16px' }}
                    />
                    <IonText color="medium">
                        <h3>No swap operations yet</h3>
                        <p>Request a quote above to get started with submarine swaps</p>
                    </IonText>
                </IonCardContent>
            </IonCard>
        )}

        {/* Refundable swaps - show first */}
        {(groupedSwaps.expired_paid_quote.length > 0 || groupedSwaps.failed_expired.length > 0) && (
            <>
                <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                    <IonIcon icon={alertCircle} style={{ marginRight: "8px" }} />
                    Refundable Swaps
                </IonText>
                {[...groupedSwaps.expired_paid_quote, ...groupedSwaps.failed_expired].map(swap => (
                    <SwapCard
                        key={swap.operation.quote.swap_operation_id}
                        swap={swap}
                        refundingOp={refundingOp}
                        setRefundingOp={setRefundingOp}
                        refundSatPerVByte={refundSatPerVByte}
                        setRefundSatPerVByte={setRefundSatPerVByte}
                        refundSwap={refundSwap}
                        doSwap={doSwap}
                    />
                ))}
            </>
        )}

        {/* Unpaid quotes */}
        {groupedSwaps.unpaid_quote.length > 0 && (
            <>
                <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                    Unpaid Quotes
                </IonText>
                {groupedSwaps.unpaid_quote.map(swap => (
                    <SwapCard
                        key={swap.operation.quote.swap_operation_id}
                        swap={swap}
                        refundingOp={refundingOp}
                        setRefundingOp={setRefundingOp}
                        refundSatPerVByte={refundSatPerVByte}
                        setRefundSatPerVByte={setRefundSatPerVByte}
                        refundSwap={refundSwap}
                        doSwap={doSwap}
                    />
                ))}
            </>
        )}

        {/* Paid pending */}
        {groupedSwaps.paid_pending.length > 0 && (
            <>
                <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                    Paid - Pending Completion
                </IonText>
                {groupedSwaps.paid_pending.map(swap => (
                    <SwapCard
                        key={swap.operation.quote.swap_operation_id}
                        swap={swap}
                        refundingOp={refundingOp}
                        setRefundingOp={setRefundingOp}
                        refundSatPerVByte={refundSatPerVByte}
                        setRefundSatPerVByte={setRefundSatPerVByte}
                        refundSwap={refundSwap}
                        doSwap={doSwap}
                    />
                ))}
            </>
        )}

        {/* Completed */}
        {groupedSwaps.completed.length > 0 && (
            <>
                <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                    Completed Swaps
                </IonText>
                {groupedSwaps.completed.map(swap => (
                    <SwapCard
                        key={swap.operation.quote.swap_operation_id}
                        swap={swap}
                        refundingOp={refundingOp}
                        setRefundingOp={setRefundingOp}
                        refundSatPerVByte={refundSatPerVByte}
                        setRefundSatPerVByte={setRefundSatPerVByte}
                        refundSwap={refundSwap}
                        doSwap={doSwap}
                    />
                ))}
            </>
        )}

        {/* Failed (non-expired) */}
        {groupedSwaps.failed.length > 0 && (
            <>
                <IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold", display: "block", marginBottom: "8px" }}>
                    Failed Swaps
                </IonText>
                {groupedSwaps.failed.map(swap => (
                    <SwapCard
                        key={swap.operation.quote.swap_operation_id}
                        swap={swap}
                        refundingOp={refundingOp}
                        setRefundingOp={setRefundingOp}
                        refundSatPerVByte={refundSatPerVByte}
                        setRefundSatPerVByte={setRefundSatPerVByte}
                        refundSwap={refundSwap}
                        doSwap={doSwap}
                    />
                ))}
            </>
        )}
    </IonContent>

}
