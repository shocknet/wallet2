import { useEffect, useMemo, useState } from "react"
import { Period } from "@/Components/Dropdowns/LVDropdown"
import { toast } from "react-toastify";
import * as Types from '../../../Api/pub/autogenerated/ts/types';
import { IonButton, IonContent, IonItem, IonPage, IonHeader, useIonLoading, useIonRouter, IonRow, IonText, IonInput } from "@ionic/react";
import { flashOutline, linkOutline, personOutline } from "ionicons/icons";
import MetricsSubPageToolbar from "@/Layout2/Metrics/MetricsSubPageToolbar";
import { useAppSelector } from "@/State/store/hooks";
import { NprofileView, selectAdminNprofileViews } from "@/State/scoped/backups/sources/selectors";
import { selectSelectedMetricsAdminSourceId } from "@/State/runtime/slice";
import { InvoiceSwapsList, InvoiceSwapQuote } from "../../../Api/pub/autogenerated/ts/types";
import { fetcher, FetcherFuncs } from "../fetcher";
import AmountInput from "@/Components/AmountInput";

export default function SubmarineSwaps({ adminSource }: { adminSource: NprofileView | undefined }) {
    const router = useIonRouter();
    const [invoice, setInvoice] = useState<string>("");
    const [satPerVByte, setSatPerVByte] = useState<number>(0);
    const [quotes, setQuotes] = useState<InvoiceSwapQuote[]>([]);
    const [refundingOp, setRefundingOp] = useState<string | null>(null);
    const [refundSatPerVByte, setRefundSatPerVByte] = useState<number>(0);
    // const [address, setAddress] = useState<string>("");

    const [swaps, setSwaps] = useState<InvoiceSwapsList>({ quotes: [], swaps: [] });
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState<string | null>(null)

    const [presentLoading, dismissLoading] = useIonLoading();

    const fetch = <T extends readonly unknown[]>(funcs: FetcherFuncs<T>, loadingMessage: string) => {
        if (!adminSource) return;
        return fetcher({ pubkey: adminSource.lpk, relays: adminSource.relays }, adminSource.keys, {
            onStart: async () => { setError(null); setLoading(true); await dismissLoading(); await presentLoading(loadingMessage); },
            onEnd: async () => { setLoading(false); await dismissLoading(); },
            onFail: (error) => { setError(error); toast.error(error); },
        }, funcs)
    }


    useEffect(() => {
        fetchSwaps()
    }, [adminSource?.sourceId])

    const fetchSwaps = async () => {
        const res = await fetch([(client) => client.ListAdminInvoiceSwaps()], "Fetching swaps...")
        if (!res) return;
        const [swaps] = res
        setSwaps(swaps);
    }
    const requestQuote = async () => {
        const res = await fetch([(client) => client.GetAdminInvoiceSwapQuotes({ invoice: invoice })], "Fetching quotes...")
        if (!res) return;
        const [quote] = res
        setQuotes(quote.quotes);
    }

    const doSwap = async (swapOpId: string) => {
        if (!satPerVByte) {
            toast.error("No sat per v byte found");
            return;
        }
        const req: Types.PayAdminInvoiceSwapRequest = { sat_per_v_byte: satPerVByte, swap_operation_id: swapOpId }
        const res = await fetch([(client) => client.PayAdminInvoiceSwap(req)], "Doing swap...")
        if (!res) return;
        fetchSwaps();
    }
    const cancelSwap = () => {
        setQuotes([]);
        fetchSwaps();
    }

    const refundSwap = async () => {
        if (!refundingOp) {
            toast.error("No swap operation id found");
            return;
        }
        const req: Types.RefundAdminInvoiceSwapRequest = { sat_per_v_byte: refundSatPerVByte, swap_operation_id: refundingOp }
        const res = await fetch([(client) => client.RefundAdminInvoiceSwap(req)], "Refunding swap...")
        if (!res) return;
        fetchSwaps();
    }

    return <IonContent className="ion-padding ion-content-no-footer">
        {error && (
            <div style={{ color: "red", padding: 12 }}>
                <div style={{ fontWeight: 700, marginBottom: 8 }}>Something went wrong</div>
                <div style={{ opacity: 0.85, marginBottom: 12 }}>{error}</div>
                <div style={{ display: "flex", gap: 8 }}>
                    <IonButton onClick={() => void fetchSwaps()}>Retry</IonButton>
                    <IonButton fill="outline" onClick={() => router.push("/metrics/select", "back")}>
                        Change Source
                    </IonButton>
                </div>
            </div>
        )}
        {quotes.length === 0 && <>
            <IonRow className="ion-margin-top"> <IonText>Amount received by destination address</IonText></IonRow>
            <IonInput
                label="Invoice"
                value={invoice}
                onIonChange={(e) => setInvoice(e.detail.value || "")}
            />
            <IonButton onClick={requestQuote}>
                Request Quotes
            </IonButton>
        </>}
        {quotes.length > 0 && <IonRow><IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold" }}>New Quotes</IonText></IonRow>}
        {quotes.length > 0 && quotes.map(quote => <div key={quote.swap_operation_id}>
            <IonRow> <IonText style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Quote from {quote.service_url}</IonText></IonRow>
            <IonRow className="ion-margin-top"> <IonText>{quote.invoice_amount_sats} sats invoice will be paid by swap service</IonText></IonRow>
            <IonRow  > <IonText>{quote.address} needs to receive {quote.transaction_amount_sats} sats to perform the swap</IonText></IonRow>
            <IonRow  > <IonText>diff: {quote.transaction_amount_sats - quote.invoice_amount_sats}</IonText></IonRow>
            <IonRow>
                <IonText>Sat per v byte</IonText>
                <IonInput
                    value={satPerVByte}
                    onIonChange={(e) => setSatPerVByte(Number(e.detail.value) || 0)}
                />
            </IonRow>
            <IonButton onClick={() => doSwap(quote.swap_operation_id)}>Swap</IonButton>
        </div>)}
        {quotes.length > 0 && <IonButton onClick={cancelSwap}>Change Swap Invoice</IonButton>}

        {swaps.quotes.length > 0 && <IonRow><IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Old Quotes</IonText></IonRow>}
        {swaps.quotes.map(quote => <div key={quote.swap_operation_id}>
            <IonRow> <IonText style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Quote from {quote.service_url}</IonText></IonRow>
            <IonRow className="ion-margin-top"> <IonText>{quote.invoice_amount_sats} sats invoice will be paid by swap service</IonText></IonRow>
            <IonRow  > <IonText>{quote.address} needs to receive {quote.transaction_amount_sats} sats to perform the swap</IonText></IonRow>
            <IonRow  > <IonText>diff: {quote.transaction_amount_sats - quote.invoice_amount_sats}</IonText></IonRow>
            {refundingOp !== quote.swap_operation_id && quote.tx_id && <IonButton onClick={() => setRefundingOp(quote.swap_operation_id)}>Refund</IonButton>}
            {refundingOp !== quote.swap_operation_id && !quote.tx_id && <IonButton onClick={() => doSwap(quote.swap_operation_id)}>Swap</IonButton>}
            {refundingOp === quote.swap_operation_id && <>
                <IonRow>
                    <IonText>Sat per v byte</IonText>
                    <IonInput
                        value={refundSatPerVByte}
                        onIonChange={(e) => setRefundSatPerVByte(Number(e.detail.value) || 0)}
                    />
                </IonRow>
                <IonButton onClick={() => refundSwap()}>Refund</IonButton>
            </>}
        </div>)}
        {swaps.swaps.length > 0 && <IonRow><IonText className="ion-margin-top" style={{ fontSize: "1.2rem", fontWeight: "bold" }}>Swaps</IonText></IonRow>}
        {swaps.swaps.map(op => <div key={op.swap_operation_id}>
            <IonItem>
                {!op.failure_reason && <IonText>success: {op.operation_payment?.amount} sats to {op.invoice_paid}</IonText>}
                {op.failure_reason && refundingOp !== op.swap_operation_id && <>
                    <IonText>failed: {op.operation_payment?.amount} sats to {op.invoice_paid}</IonText>
                    <IonText>reason: {op.failure_reason}</IonText>
                    <IonButton onClick={() => setRefundingOp(op.swap_operation_id)}>Refund</IonButton>
                </>}
                {refundingOp === op.swap_operation_id && <>
                    <IonText>refunding: {op.operation_payment?.amount} sats</IonText>
                    <IonRow>
                        <IonText>Sat per v byte</IonText>
                        <IonInput
                            value={refundSatPerVByte}
                            onIonChange={(e) => setRefundSatPerVByte(Number(e.detail.value) || 0)}
                        />
                    </IonRow>
                    <IonButton onClick={() => refundSwap()}>Refund</IonButton>
                </>}
            </IonItem>
        </div>)}
    </IonContent>

}
